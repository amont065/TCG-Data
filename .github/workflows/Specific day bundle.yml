name: Bundle By Date Range

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: "UTC start date (YYYY-MM-DD)"
        required: true
      end_date:
        description: "UTC end date (YYYY-MM-DD)"
        required: true

jobs:
  bundle:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq zip

      - name: Set time variables
        run: |
          START_DATE="${{ inputs.start_date }}"
          END_DATE="${{ inputs.end_date }}"

          # Inclusive range by using an exclusive upper bound (end_date + 1 day at 00:00Z)
          START_TS=$(date -u -d "$START_DATE 00:00" +'%Y-%m-%dT%H:%M:%SZ')
          END_EXCL_TS=$(date -u -d "$END_DATE +1 day 00:00" +'%Y-%m-%dT%H:%M:%SZ')

          BUNDLE_LABEL="${START_DATE}_to_${END_DATE}"
          BUNDLE_RUN_TS=$(date -u +'%Y-%m-%dT%H%M%SZ')

          echo "START_DATE=$START_DATE" >> "$GITHUB_ENV"
          echo "END_DATE=$END_DATE" >> "$GITHUB_ENV"
          echo "START_TS=$START_TS" >> "$GITHUB_ENV"
          echo "END_EXCL_TS=$END_EXCL_TS" >> "$GITHUB_ENV"
          echo "BUNDLE_LABEL=$BUNDLE_LABEL" >> "$GITHUB_ENV"
          echo "BUNDLE_RUN_TS=$BUNDLE_RUN_TS" >> "$GITHUB_ENV"

      - name: Fetch runs in range
        run: |
          # Increase limit to reduce chances of missing runs in high-volume repos
          gh run list \
            --workflow Hourly_Scrape_Win.yml \
            --limit 5000 \
            --json createdAt,databaseId \
            | jq -r --arg START "$START_TS" --arg END "$END_EXCL_TS" '
                .[]
                | select(.createdAt >= $START and .createdAt < $END)
                | "\(.databaseId)\t\(.createdAt)"
              ' > run_list.tsv

          echo "Runs found:"
          wc -l run_list.tsv || true
          head -n 20 run_list.tsv || true

      - name: Download artifacts (organized by run timestamp)
        run: |
          mkdir -p bundle

          # Each line is: <run_id>\t<createdAt>
          while IFS=$'\t' read -r rid createdAt; do
            [ -z "$rid" ] && continue

            # Make createdAt safe for folder names (remove Z, replace ":" with "-")
            safeCreatedAt=$(echo "$createdAt" | sed 's/Z$//' | sed 's/:/-/g')

            runDir="bundle/${safeCreatedAt}_run-${rid}"
            mkdir -p "$runDir/csv" "$runDir/logs"

            # Keep original artifact filenames; avoid failing if a run doesn't have a matching artifact
            gh run download "$rid" --pattern "cards-main-*" -D "$runDir/csv" || true
            gh run download "$rid" --pattern "debug-logs-*" -D "$runDir/logs" || true
          done < run_list.tsv

      - name: Create single zip bundle
        run: |
          zip -r "bundle-${{ env.BUNDLE_LABEL }}-generated-${{ env.BUNDLE_RUN_TS }}.zip" bundle

      - name: Upload single bundled artifact
        uses: actions/upload-artifact@v4
        with:
          name: bundle-${{ env.BUNDLE_LABEL }}-generated-${{ env.BUNDLE_RUN_TS }}
          path: bundle-${{ env.BUNDLE_LABEL }}-generated-${{ env.BUNDLE_RUN_TS }}.zip
