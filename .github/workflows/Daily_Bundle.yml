name: Daily Bundle

on:
  schedule:
    - cron: "30 2 * * *"
  workflow_dispatch:

jobs:
  bundle:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI and jq
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: Set time variables
        id: times
        run: |
          echo "CUTOFF=$(date -u -d '24 hours ago' +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"
          echo "DATE=$(date -u +'%Y-%m-%d')" >> "$GITHUB_ENV"

      - name: Fetch recent runs
        id: runs
        run: |
          gh api "/repos/${{ github.repository }}/actions/workflows/Hourly_Scrape_Win.yml/runs" > runs.json
          ids=$(jq -r --arg START_OF_DAY "$START_OF_DAY" --arg END_OF_DAY "$END_OF_DAY" '.workflow_runs[] | select(.created_at >= $START_OF_DAY and .created_at < $END_OF_DAY) | .id' runs.json | tr '\n' ' ')
          echo "run_ids=$ids" >> "$GITHUB_OUTPUT"
          echo "START_OF_DAY=$(date -u -d 'yesterday 00:00' +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"
          echo "END_OF_DAY=$(date -u -d 'today 00:00' +'%Y-%m-%dT%H:%M:%SZ')" >> "$GITHUB_ENV"

      - name: Download artifacts
        run: |
          mkdir -p csv logs
          for rid in ${{ steps.runs.outputs.run_ids }}; do
            gh run download "$rid" --pattern "cards-main-*" -D csv || true
            gh run download "$rid" --pattern "debug-logs-*" -D logs || true
          done

      - name: Zip CSV
        run: zip -r "cards-main-${{ env.DATE }}.zip" csv

      - name: Zip Logs
        run: zip -r "debug-logs-${{ env.DATE }}.zip" logs

      - name: Upload bundled cards
        uses: actions/upload-artifact@v4
        with:
          name: cards-main-${{ env.DATE }}
          path: cards-main-${{ env.DATE }}.zip

      - name: Upload bundled logs
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs-${{ env.DATE }}
          path: debug-logs-${{ env.DATE }}.zip
